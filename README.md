# Асинхронный WebAPI сервис

## Disclaimer 

This is a demo project and shall not be used in production.  
The code is distributed under MIT license (see the LICENSE file).

## Краткое описание проекта

Проект состоит из 3х сервисов:
- клиентский
- web
- фоновый

Все сервисы запакованны в docker-контейнеры и запускаются с помощью docker-compose. 
Для целей демонстрации работоспособности создаётся отдельная сеть, объединяющая следующие контейнеры:
- postgres (тестовая база данных)
- webservice (асинхронный WebAPI сервис)
- client (сервис, имитирующий клиент)
- background1 (первая копия фонового сервиса)
- background2 (вторая копия фонового сервиса)

## WebAPI сервис

Сервис должен принимать на вход строку вида ` '{IP address} {HTTP method} {URI} {HTTP status code}' `, парсить её и сохранять в базу PostgreSQL, помечая каждую строку уникальным идентификатором и временем сохранения. А также, возвращать результат из базы по запросу.

Stack: FastAPI, ~~Pydantic~~ PostgreSQL, SQLAlchemy, Docker-compose  
(Pydantic не использовался, поскольку в задании не требовалось проводить проверку корректности значений).

### Спецификация endpoint'ов:

**POST /api/data**  

Request:
```
{
    "log": str
}
```

Responce:  
| status code | описание |
| :---: | :---: |
| 201 | Лог сохранен |
| 418 | Что-то пошло не так |

**GET /api/data**  

Request:  
- `/api/data` - запрос всех имеющихся на данный момент записей 
- `/api/data?id=unique_id` - запрос всех записей, добавленных позже указанной записи

Responce:  
```
[
    {
        "id": uuid4,
        "created": datetime,
        "log": {
            "ip": IPv4,
            "method": str,
            "uri": URI,
            "status_code": int
        }
    }
]
```

## Сервис, имитирующий клиент

Сервис генерирует текст вида ` '{IP address} {HTTP method} {URI} {HTTP status code}' ` и отправляет его WebAPI сервису POST запросами.  
Сервис работает в N потоков с рандомной задержкой до M мс между запросами.  
N и M задаются переменными окружения `THREADS` и `REQUESTS_DELAY`, соответственно.  
Сгенерированный текст логируется в файлы `short_unique_id.log`, где *short_unique_id* - уникальный идентификатор каждого потока (усечённый uuid4).

## Сервис, имитирующий фоновую обработку

Сервис периодически получает GET запросами данные с WebAPI сервиса и сохраняет их в примонтированный файл.  
Демонстрация возможности работы сервиса в несколько instance'ов с общим разделяемым ресурсом (монтированным файлом), достигается путём запуска двух идентичных docker-контейнеров с разным временем задержки между запросами.  
Монтированный файл указывается через переменную окружения `TARGET_FILE`.

---
&copy; 2023
